name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  quality-checks:
    name: Quality Checks (Lint & Typecheck)
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run type checker
        run: npm run typecheck

  tests:
    name: Test (Vitest)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test

  coverage:
    name: Coverage Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Check coverage threshold
        run: |
          node <<'NODE'
          const fs = require('node:fs');
          const path = 'coverage/lcov.info';
          const threshold = 70;
          if (!fs.existsSync(path)) {
            console.error(`❌ Coverage file not found at ${path}`);
            process.exit(1);
          }
          const lines = fs.readFileSync(path, 'utf8').split('\n');
          let linesHit = 0;
          let linesFound = 0;
          for (const line of lines) {
            if (line.startsWith('LH:')) linesHit += Number(line.slice(3));
            if (line.startsWith('LF:')) linesFound += Number(line.slice(3));
          }
          const coverage = linesFound === 0 ? 0 : (linesHit / linesFound) * 100;
          const formatted = coverage.toFixed(2);
          console.log(`Line coverage: ${formatted}%`);
          if (coverage < threshold) {
            console.error(`❌ Coverage ${formatted}% is below threshold of ${threshold}%`);
            process.exit(1);
          }
          console.log(`✅ Coverage ${formatted}% meets threshold of ${threshold}%`);
          NODE

  build:
    name: Build Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Verify build output
        run: |
          if [ ! -f "dist/cli/index.js" ]; then
            echo "❌ Build output not found at dist/cli/index.js"
            exit 1
          fi
          echo "✅ Build output verified"

      - name: Generate npm pack artifact
        run: |
          mkdir -p tmp-toolchain
          rm -f tmp-toolchain/*.tgz
          npm pack --pack-destination tmp-toolchain/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-artifact
          path: |
            dist/
            tmp-toolchain/*.tgz

  test-cli-installation:
    name: Test CLI Installation (Node.js ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        node-version: [20.x, 22.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-artifact
          path: artifacts

      - name: Install CLI globally from tarball
        run: |
          set -eo pipefail
          TAR=$(ls artifacts/tmp-toolchain/ng-di-graph-*.tgz | head -n 1)
          echo "Installing $TAR"
          npm install -g "$TAR"

      - name: Test CLI version command
        run: ng-di-graph --version | grep "0.1.0"

      - name: Test CLI help command
        run: ng-di-graph --help | grep "ng-di-graph"

      - name: Test CLI execution smoke test
        run: |
          cd src/tests/fixtures
          ng-di-graph -p tsconfig.json -f json > /tmp/output.json
          if [ ! -s /tmp/output.json ]; then
            echo "❌ CLI execution failed - no output generated"
            exit 1
          fi
          echo "✅ CLI execution successful"
